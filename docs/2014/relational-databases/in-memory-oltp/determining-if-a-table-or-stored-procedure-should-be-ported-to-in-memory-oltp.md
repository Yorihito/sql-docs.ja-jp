---
title: テーブルまたはストアド プロシージャをインメモリ OLTP に移植する必要があるかどうかの確認 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
helpviewer_keywords:
- Analyze, Migrate, Report
- AMR
ms.assetid: c1ef96f1-290d-4952-8369-2f49f27afee2
author: rothja
ms.author: jroth
ms.openlocfilehash: 8e517cff394bc0c813e34763469f75147a0a16c5
ms.sourcegitcommit: 57f1d15c67113bbadd40861b886d6929aacd3467
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/18/2020
ms.locfileid: "85050238"
---
# <a name="determining-if-a-table-or-stored-procedure-should-be-ported-to-in-memory-oltp"></a>テーブルまたはストアド プロシージャをインメモリ OLTP に移植する必要があるかどうかの確認
  のトランザクションパフォーマンスコレクターは、 [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] インメモリ OLTP によってデータベースアプリケーションのパフォーマンスが向上するかどうかを評価するのに役立ちます。 また、トランザクション パフォーマンス分析レポートによって、アプリケーションでインメモリ OLTP を有効にするために必要な作業量が示されます。 インメモリ OLTP に移植するディスク ベース テーブルを特定した後で [メモリ最適化アドバイザー](memory-optimization-advisor.md)を使用すると、テーブルを移行しやすくなります。 同様に、 [Native Compilation Advisor](native-compilation-advisor.md) は、ストアド プロシージャをネイティブ コンパイル ストアド プロシージャに移植するために役立ちます。  
  
 このトピックでは、次の方法について説明します。  
  
-   管理データ ウェアハウスの構成。  
  
-   データ コレクションの構成。  
  
-   パフォーマンス クリティカルなテーブルとストアド プロシージャを特定するためのトランザクション パフォーマンス分析レポートの生成。  
  
 移行方法の詳細については、「[インメモリ OLTP-一般的なワークロードパターンと移行に関する考慮事項](https://msdn.microsoft.com/library/dn673538.aspx)」を参照してください。  
  
 トランザクション パフォーマンス コレクターとトランザクション パフォーマンス分析レポートは、次の操作を実行するために使用できます。  
  
-   ワークロードを分析して、インメモリ OLTP によってパフォーマンスが向上するかどうかを調べる。 トランザクション パフォーマンス コレクターは、ワークロードのパフォーマンス特性を収集および評価します。 . 次に、トランザクション パフォーマンス コレクターは、インメモリ OLTP に変換することよっても最も大きいメリットが得られるテーブルおよびストアド プロシージャをそれぞれ推奨します。  
  
-   インメモリ OLTP への移行の計画および実行を支援する。 ディスク ベース テーブルからメモリ最適化テーブルへの移行パスは時間がかかる場合があります。 メモリ最適化アドバイザーは、インメモリ OLTP にテーブルを移行する前にテーブルの非互換性を識別するために役立ちます。 また、メモリ最適化アドバイザーは、テーブルをメモリ最適化テーブルに移行した場合のアプリケーションへの影響を理解するのに役立ちます。  
  
     インメモリ OLTP への移行を計画したとき、およびテーブルおよびストアド プロシージャの一部をインメモリ OLTP に移行するための作業を行うときに、アプリケーションがインメモリ OLTP のメリットを得られるかどうかを確認できます。  
  
    > [!IMPORTANT]  
    >  データベース システムのパフォーマンスはさまざまな要因に左右されますが、そのすべてをトランザクション パフォーマンス コレクターで観察および測定できるわけではありません。 したがって、トランザクション パフォーマンス分析レポートは、作成した予測が実際のパフォーマンスの向上と一致することを保証するものではありません。  
  
 のインストール時に [**管理ツール-基本**] または [**管理ツール-詳細**] を選択すると、トランザクションパフォーマンスコレクターとトランザクションパフォーマンス分析レポートを生成する機能がインストールされ [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] ます。  
  
## <a name="best-practices"></a>ベスト プラクティス  
 推奨されるワークフローを、次のフローチャートで説明します。 黄色のノードは省略可能な手順を表しています。  
  
 ![AMR ワークフロー](../../database-engine/media/amr-1.gif "AMR ワークフロー")  
  
 パフォーマンス ベースラインは、任意の方法を使用して設定できます。このような方法には、パフォーマンス カウンターのログまたは [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] の利用状況モニターを使用する方法がありますが、これに限定されるものではありません。 パフォーマンス ベースラインと比較において使用する情報は次のとおりです。  
  
-   [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] の CPU 消費量。  
  
-   [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] のメモリ消費量。  
  
-   [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] の I/O アクティビティ。  
  
-   トランザクションの処理中のインスタンスのトランザクション スループット。  
  
 トランザクション パフォーマンス コレクターは、15 分ごとにデータをキャプチャします。 有効な結果を得るには、少なくとも 1 時間、トランザクション パフォーマンス コレクターを実行してください。 最良の結果を得るには、主要なシナリオでデータをキャプチャするために必要なだけ時間をかけて、トランザクション パフォーマンス コレクターを実行します。 トランザクション パフォーマンス分析レポートを生成するのは、データの収集が完了した後にしてください。  
  
 実稼動中の [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] インスタンスで実行されるようにトランザクション パフォーマンス コレクターを構成します。また、開発 (テスト) 環境の [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] インスタンスではデータを収集して、オーバーヘッドが最小限に抑えられるように構成します。 リモートインスタンス上の管理データウェアハウスデータベースにデータを保存する方法については [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 、「[リモート SQL Server インスタンスでのデータ収集の構成](determining-if-a-table-or-stored-procedure-should-be-ported-to-in-memory-oltp.md#xxx)」を参照してください。  
  
## <a name="performance-impacts"></a>パフォーマンスへの影響  
 トランザクション パフォーマンス コレクターは、次の 2 つのデータ コレクション セットで構成されます。  
  
-   テーブルの使用状況に関する分析  
  
-   ストアド プロシージャに関する分析  
  
 コレクション セットは 15 分ごとに 3 つの動的管理ビュー (DMV) からデータを収集し、管理データ ウェアハウスとして機能するように構成されたデータベースにそのデータをアップロードします。 収集したデータをアップロードすると、パフォーマンスは極小さな影響を受けます。  
  
## <a name="use-the-transaction-performance-collector"></a>トランザクション パフォーマンス コレクターの使用  
 次の手順を実行するには、[!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] の [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] が必要です。  
  
> [!IMPORTANT]  
>  プロファイル中は、スキーマの変更 (データベースの追加または削除、テーブルの作成または削除など) を行わないでください。 データの収集中にデータベースのスキーマを変更すると、レポートにデータベースが正確に含まれなくなる場合があります。  
  
### <a name="configure-management-data-warehouse"></a>管理データウェアハウスの構成  
 トランザクション パフォーマンス コレクターを使用するには、管理データ ウェアハウスを構成する必要があります。  
  
 データ (プロファイル) を収集する [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] のインスタンスのバージョンは、管理データ ウェアハウスが構成されている [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] と同一のバージョンか、それよりも古いバージョンである必要があります。  
  
1.  オブジェクト エクスプローラーで、 **[管理]** を展開します。  
  
2.  [**データコレクション**] を右クリックし、[**タスク**] をクリックして、[**管理データウェアハウス**] を構成します。 **管理データウェアハウスの構成ウィザード**が開始されます。  
  
3.  [**次**へ] をクリックして、管理データウェアハウスとして機能するデータベースを選択します。  
  
4.  [**新規**] をクリックして、プロファイルデータを保持する新しいデータベースを作成します。 データベースの作成が完了したら、ウィザードの [**次へ**] をクリックします。  
  
5.  ウィザードの次の手順では、ユーザーとログインを追加します。 MDW インスタンスのロールのメンバーシップにログインをマップできます。 ローカル インスタンスからデータを収集する場合は、この手順は必要ありません。 ローカル インスタンスからデータを収集しない場合、プロファイルされるトランザクションを実行するアカウントにデータベース ロール メンバーシップ `mdw_admin` を許可できます。 完了したら、 **[次へ]** をクリックします。  
  
6.  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] エージェントが実行されていることを確認します。  
  
7.  次の画面で、[**完了**] をクリックしてウィザードを終了します。  
  
### <a name="configure-data-collection-on-a-local-ssnoversion-instance"></a>ローカル [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] インスタンスでのデータ収集の構成  
 データ コレクションを実行するには、[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] エージェントが起動されている必要があります。 サーバーでデータ コレクターを 1 つだけ構成する必要があります。  
  
 データコレクターは、SQL Server 2012 以降のバージョンので構成でき [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] ます。  
  
 同じインスタンスの管理データ ウェアハウス データベースにアップロードするようにデータ コレクションを構成するには  
  
1.  **オブジェクトエクスプローラー**で、[**管理**] を展開します。  
  
2.  [**データコレクション**] を右クリックし、[**タスク**] を選択して、[**データコレクション**] を構成します。 **データコレクション構成ウィザード**が開始されます。  
  
3.  プロファイルデータを収集するデータベースを選択するには、[**次**へ] をクリックします。  
  
4.  現在の [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] インスタンスと、そのインスタンス上の管理データ ウェアハウス データベースを選択します。  
  
5.  **[有効にするデータコレクターセットを選択し**てください] というラベルの付いたボックスで、[**トランザクションパフォーマンスコレクションセット**] を選択します。 完了したら、**[次へ]** をクリックします。  
  
6.  選択内容を確認します。 設定を変更するには、[**戻る**] をクリックします。 終了したら **[完了]** をクリックします。  
  
###  <a name="configure-data-collection-on-a-remote-ssnoversion-instance"></a><a name="xxx"></a>リモートインスタンスでのデータ収集の構成 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]  
 データを収集するには、データを収集するインスタンスで [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] エージェントが開始されている必要があります。  
  
 データコレクターは、SQL Server 2012 以降のバージョンので構成でき [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] ます。  
  
 トランザクションがプロファイルされる場所とは異なるインスタンス上の管理データ ウェアハウス データベースにデータ コレクターがデータをアップロードするためには、適切な資格情報が設定された [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] エージェント プロキシが必要です。 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] エージェント プロキシを有効にするには、ドメイン対応のログインを持つ資格情報を最初に設定する必要があります。 ドメイン対応のログインは、管理データ ウェアハウス データベースの `mdw_admin` グループのメンバーである必要があります。 資格情報を作成する方法については[、「方法: 資格情報を作成する (SQL Server Management Studio)](../security/authentication-access/create-a-credential.md) 」を参照してください。  
  
 別のインスタンスの管理データ ウェアハウス データベースにアップロードするようにデータ コレクションを構成するには  
  
1.  インメモリ OLTP に移行するディスクベースのオブジェクトを含むインスタンスで、オブジェクトエクスプローラーの [**管理**] ノードを展開します。  
  
2.  [**データコレクション**] を右クリックして [**タスク**] を選択し、[**データコレクションの構成**] をクリックします。 **データコレクション構成ウィザード**が開始されます。  
  
3.  プロファイルデータを収集するデータベースを選択するには、[**次**へ] をクリックします。  
  
4.  他の [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] インスタンスに管理データ ウェアハウス データベースが存在していることを確認します。  
  
5.  別の [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] インスタンスと、そのインスタンス上の管理データ ウェアハウス データベースを選択します。  
  
     データ (プロファイル) を収集する [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] のインスタンスのバージョンは、管理データ ウェアハウスが構成されている [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] と同一のバージョンか、それよりも古いバージョンである必要があります。  
  
6.  **[有効にするデータコレクターセットを選択し**てください] というラベルの付いたボックスで、[**トランザクションパフォーマンスコレクションセット**] を選択します。  
  
7.  [ ** [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] リモートアップロードにエージェントプロキシを使用**する] を選択します。  
  
8.  完了したら、**[次へ]** をクリックします。  
  
9. プロキシを選択します。  
  
     新しい [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] エージェント プロキシを作成する場合  
  
    1.  [**新規**] をクリックして、[**新しいプロキシアカウント**] ダイアログボックスを表示します。  
  
    2.  [**新しいプロキシアカウント**] ダイアログボックスで、プロキシの名前を入力し、資格情報を選択して、必要に応じて説明を入力します。 次に、[**プリンシパル**] をクリックします。  
  
    3.  [**追加**] をクリックし、[ **Msdb**ロール] を選択します。  
  
    4.  を選択 `dc_proxy` し、[ **OK]** をクリックします。 もう一度、[**OK**] をクリックします。  
  
     正しいプロキシを選択したら、[**次へ**] をクリックします。  
  
10. システムコレクションセットを構成するには、**システムコレクションセット**を確認し、[**次へ**] をクリックします。  
  
11. 選択内容を確認します。 設定を変更するには、[**戻る**] をクリックします。 完了したら Clicck を**終了**します。  
  
 データ コレクション セットが構成され、インスタンス上で実行されます。  
  
### <a name="generate-reports"></a>レポートの生成  
 トランザクションパフォーマンス分析レポートを生成するには、管理データウェアハウスのデータベースを右クリックし、[**レポート**]、[**管理データウェアハウス**]、[**トランザクションパフォーマンス分析の概要**] の順に選択します。  
  
 レポートは、ワークロード サーバーのすべてのユーザー データベースに関する情報を収集します。 管理データ ウェアハウス (MDW) データベースがローカル コンピューターに存在する場合は、レポートに MDW データベースが表示されます。  
  
 経過時間のうち CPU 時間の割合が高いストアド プロシージャは、移行の対象となります。 ネイティブ コンパイル ストアド プロシージャはメモリ最適化テーブルのみを参照できるため、レポートはすべてのテーブル参照を示します。これは移行コストに追加できます。  
  
 テーブルの詳細なレポートは、3 つのセクションで構成されています。  
  
-   スキャン統計セクション  
  
     このセクションには、データベース テーブルのスキャンに関して収集された統計を示す単一のテーブルが含まれています。 列は次のとおりです。  
  
    -   総アクセスに対する比率。 データベース全体のアクティビティに対する、このテーブルでのスキャンとシークの割合です。 この割合が高くなるほど、データベース内の他のテーブルと比較して、テーブルが使用される頻度が高くなります。  
  
    -   参照統計/範囲スキャン統計。 この列には、プロファイル中にテーブルで行われたポイント参照と範囲スキャン (インデックス スキャンとテーブル スキャン) の回数が記録されます。 トランザクションごとの平均は推定値です。  
  
    -   相互運用による到達率と本来の到達率。 これらの列では、テーブルがメモリ最適化テーブルに変換された場合にポイント参照または範囲スキャンによってパフォーマンスがどの程度向上するかを予測します。  
  
-   競合統計セクション  
  
     このセクションには、データベース テーブルの競合を示すテーブルが含まれます。 データベースラッチとロックの詳細については、「[ロックアーキテクチャ](https://msdn.microsoft.com/library/aa224738\(v=sql.80\).aspx)」を参照してください。 次の列で構成されます。  
  
    -   待機の総数に対する比率。 データベースのアクティビティと比較した、このデータベース テーブルでのラッチ待機とロック待機の割合です。 この割合が高くなるほど、データベース内の他のテーブルと比較して、テーブルが使用される頻度が高くなります。  
  
    -   ラッチ統計。 これらの列には、このテーブルの関連するクエリに対するラッチ待機数が記録されます。 ラッチの詳細については、「[ラッチ](https://msdn.microsoft.com/library/aa224727\(v=SQL.80\).aspx)」を参照してください。 この数値が大きくなるほど、テーブルでのラッチの競合が増加します。  
  
    -   ロック統計。 この列のグループには、このテーブルのクエリに対するページ ロックの取得および待機の数が記録されます。 ロックの詳細については、「 [SQL Server のロックについ](https://msdn.microsoft.com/library/aa213039\(v=SQL.80\).aspx)て」を参照してください。 待機数が多いほど、テーブルでのロックの競合が増加します。  
  
-   移行難易度セクション  
  
     このセクションには、このデータベース テーブルをメモリ最適化テーブルに変換する際の難易度を示すテーブルが含まれます。 難易度が高いほど、テーブルの変換が難しくなることを示します。 このデータベーステーブルの変換に関する詳細を確認するには、[メモリ最適化アドバイザー](memory-optimization-advisor.md)を使用してください。  
  
 テーブルの詳細レポートのスキャンと競合の統計情報は、 [dm_db_index_operational_stats &#40;transact-sql&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-index-operational-stats-transact-sql)から収集および集計されます。  
  
 ストアド プロシージャの詳細レポートは、次の 2 つのセクションで構成されています。  
  
-   実行の統計セクション  
  
     このセクションには、ストアド プロシージャの実行に関して収集された統計を示すテーブルが含まれています。 次の列で構成されます。  
  
    -   キャッシュ時間。 この実行プランがキャッシュされた時間です。 ストアド プロシージャがプラン キャッシュを途中で抜けてもう一度キャッシュに入る場合、各キャッシュの時間になります。  
  
    -   総 CPU 時間。 プロファイル中にストアド プロシージャで使用された総 CPU 時間です。 この数値が大きくなるほど、ストアド プロシージャで使用された CPU が増加します。  
  
    -   総実行時間。 プロファイル中にストアド プロシージャで使用された実行時間の合計です。 この数値と CPU 時間の差が大きいほど、ストアド プロシージャによる CPU の使用効率は低くなります。  
  
    -   キャッシュ ミスの総数。 プロファイル中に、ストアド プロシージャの実行によって発生したキャッシュ ミス (物理ストレージからの読み取り) の数です。  
  
    -   実行回数。 プロファイル中にこのストアド プロシージャが実行された回数です。  
  
-   テーブル参照セクション  
  
     このセクションには、このストアド プロシージャによって参照されるテーブルを示すテーブルが含まれます。 ストアド プロシージャをネイティブ コンパイル ストアド プロシージャに変換する前に、これらすべてのテーブルをメモリ最適化テーブルに変換する必要があります。また、これらは同じサーバーおよびデータベースに存在する必要があります。  
  
 ストアドプロシージャの詳細レポートの実行の統計情報は、 [dm_exec_procedure_stats &#40;transact-sql&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-procedure-stats-transact-sql)から収集および集計されます。 参照は、 [sql_expression_dependencies &#40;transact-sql&#41;](/sql/relational-databases/system-catalog-views/sys-sql-expression-dependencies-transact-sql)から取得されます。  
  
 ストアドプロシージャをネイティブコンパイルストアドプロシージャに変換する方法の詳細については、[ネイティブコンパイルアドバイザー](native-compilation-advisor.md)を使用してください。  
  
## <a name="see-also"></a>参照  
 [インメモリ OLTP への移行](migrating-to-in-memory-oltp.md)  
  
  
